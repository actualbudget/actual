name: Test

on:
  push:
    branches:
      - master
  pull_request:
    branches: '*'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Lint
        run: yarn lint
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Typecheck
        run: yarn typecheck
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Test
        run: yarn test

  migrations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Check migrations
        run: |
          function get_migrations() {
            git ls-tree $1 --name-only packages/loot-core/migrations/ | xargs -I{} basename {} | sort -n | grep -Ev '^\.'
          }
          git fetch origin master
          old_migrations=$(get_migrations origin/master)
          newest_old_migration=$(tail -n1 <<< "$old_migrations")

          new_migrations=$(get_migrations HEAD)
          added_migrations=$(comm -13 <(echo "$old_migrations") <(echo "$new_migrations"))
          for migration in $added_migrations; do
            if [[ "$migration" < "$newest_old_migration" ]]; then
              echo "Migration $migration is older than the newest migration in master ($newest_old_migration)"
              exit 1
            fi
          done
          echo "Migrations are valid"
